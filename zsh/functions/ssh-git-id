# Usage: ssh-git-id [--fix]
# Suggests or fixes the SSH alias in a Git remote using your ~/.ssh/config.d aliases
function ssh-git-id() {
  local fix=false
  [[ "$1" == "--fix" ]] && fix=true

  local remote host_alias repo_suffix new_url suggested_alias repo_path gitdir mapping
  local config_dir="$HOME/.ssh/config.d"
  local project_identities="$HOME/.ssh/.project-identities"

  # Step 1: Parse current git remote
  remote=$(git remote get-url origin 2>/dev/null) || {
    echo "âŒ Not a Git repo or no origin remote found"
    return 1
  }

  host_alias=${remote#git@}
  host_alias=${host_alias%%:*}
  repo_suffix=${remote#*:}

  echo "ğŸ”— Git remote host: $host_alias"
  echo "ğŸ“¦ Repo path: $repo_suffix"

  # Step 2: Load known SSH aliases from ~/.ssh/config.d
  local known_aliases=()
  for file in "$config_dir"/*; do
    [[ -f "$file" ]] || continue
    while IFS= read -r line; do
      [[ "$line" == Host\ * ]] && known_aliases+=("${line#Host }")
    done < "$file"
  done

  known_aliases=($(printf '%s\n' "${known_aliases[@]}" | sort -u))

  if [[ ${#known_aliases[@]} -eq 0 ]]; then
    echo "âŒ No SSH aliases found in $config_dir"
    return 1
  fi

  # Step 3: If host_alias is not found, prompt to tailor
  local alias_found=false
  for alias in "${known_aliases[@]}"; do
    [[ "$alias" == "$host_alias" ]] && alias_found=true && break
  done

  if $alias_found; then
    echo "âœ… Host alias '$host_alias' is already valid in ~/.ssh/config.d"
    return 0
  fi

  echo "âŒ Host alias '$host_alias' not found in SSH config"
  echo "ğŸ” Searching for suggestions..."

  local github_aliases=()
  for alias in "${known_aliases[@]}"; do
    [[ "$alias" == github.* ]] && github_aliases+=("$alias")
  done

  if [[ ${#github_aliases[@]} -eq 0 ]]; then
    echo "âŒ No GitHub-style aliases found in SSH config"
    return 1
  fi

  # Step 4: Prompt with fzf or manual fallback
  if command -v fzf >/dev/null; then
    suggested_alias=$(printf '%s\n' "${github_aliases[@]}" | fzf --prompt="â“ Select SSH alias for '$host_alias': ")
  else
    echo "ğŸ“‹ GitHub aliases: ${github_aliases[*]}"
    echo -n "ğŸ”§ Enter the alias to use for this Git remote: "
    read suggested_alias
  fi

  if [[ -z "$suggested_alias" ]]; then
    echo "âš ï¸ Cancelled. No alias selected."
    return 1
  fi

  echo "âœ… Selected alias: $suggested_alias"

  # Step 5: Rewrite the remote and update .project-identities
  new_url="git@${suggested_alias}:${repo_suffix}"
  echo "ğŸ’¡ Suggested remote URL: $new_url"

  if $fix; then
    echo "ğŸ” Updating git remote origin..."
    git remote set-url origin "$new_url" || {
      echo "âŒ Failed to update remote"
      return 1
    }

    gitdir=$(git rev-parse --show-toplevel)
    repo_path="$gitdir"
    mapping="$repo_path $suggested_alias"

    mkdir -p "$(dirname "$project_identities")"
    touch "$project_identities"

    if grep -qxF "$mapping" "$project_identities"; then
      echo "ğŸ“„ Mapping already exists in .project-identities:"
    else
      echo "$mapping" >> "$project_identities"
      echo "ğŸ“ Added to .project-identities:"
    fi

    echo "    $mapping"

    echo "ğŸ”Œ Testing SSH connection..."
    ssh -T -o IdentitiesOnly=yes -o ConnectTimeout=5 "git@$suggested_alias" 2>&1 | head -n 2
  else
    echo "ğŸ’¡ To apply: run \`ssh-git-id --fix\`"
  fi
}
